<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ES Module Import Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            line-height: 1.6;
        }
        h1 { color: #333; }
        .test-result {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .pending {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }
        pre {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.9rem;
        }
        .theme-list {
            display: grid;
            gap: 1rem;
            margin: 1rem 0;
        }
        .theme-card {
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .theme-card h3 {
            margin: 0 0 0.5rem;
        }
        .theme-card p {
            margin: 0;
            color: #666;
        }
        #preview-area {
            margin-top: 2rem;
            padding: 1rem;
            border: 2px dashed #ccc;
            border-radius: 8px;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <h1>ES Module Import Test</h1>
    <p>This page tests whether ES module imports work with the <code>file://</code> protocol.</p>

    <h2>Test 1: Import Theme Registry</h2>
    <div id="registry-test" class="test-result pending">Testing...</div>

    <h2>Test 2: Load Theme Metadata</h2>
    <div id="themes-container" class="theme-list"></div>

    <h2>Test 3: Dynamic Theme Loading</h2>
    <div id="dynamic-test" class="test-result pending">Testing...</div>

    <h2>CSS Preview</h2>
    <p>Select a theme to preview its CSS:</p>
    <select id="theme-selector">
        <option value="">-- Select a theme --</option>
    </select>
    <div id="preview-area">
        <pre id="css-preview">Select a theme above to see its CSS</pre>
    </div>

    <script type="module">
        const registryResult = document.getElementById('registry-test');
        const themesContainer = document.getElementById('themes-container');
        const dynamicResult = document.getElementById('dynamic-test');
        const themeSelector = document.getElementById('theme-selector');
        const cssPreview = document.getElementById('css-preview');

        // Test 1: Import the registry
        try {
            const { themes, loadTheme, getThemeCSS } = await import('./themes/index.js');

            registryResult.className = 'test-result success';
            registryResult.innerHTML = `
                <strong>✓ Registry imported successfully!</strong><br>
                Found ${themes.length} themes: ${themes.map(t => t.id).join(', ')}
            `;

            // Test 2: Display theme metadata
            themes.forEach(theme => {
                const card = document.createElement('div');
                card.className = 'theme-card';
                card.innerHTML = `
                    <h3>${theme.name}</h3>
                    <p>${theme.description}</p>
                    <small>ID: ${theme.id}</small>
                `;
                themesContainer.appendChild(card);

                // Add to selector
                const option = document.createElement('option');
                option.value = theme.id;
                option.textContent = theme.name;
                themeSelector.appendChild(option);
            });

            // Test 3: Dynamic import
            const manuscriptModule = await loadTheme('manuscript');
            dynamicResult.className = 'test-result success';
            dynamicResult.innerHTML = `
                <strong>✓ Dynamic import works!</strong><br>
                Loaded "${manuscriptModule.name}" theme<br>
                CSS length: ${manuscriptModule.default.length} characters
            `;

            // Theme selector handler
            themeSelector.addEventListener('change', async (e) => {
                if (e.target.value) {
                    try {
                        const css = await getThemeCSS(e.target.value);
                        cssPreview.textContent = css.substring(0, 2000) + (css.length > 2000 ? '\n...(truncated)' : '');
                    } catch (err) {
                        cssPreview.textContent = 'Error loading theme: ' + err.message;
                    }
                } else {
                    cssPreview.textContent = 'Select a theme above to see its CSS';
                }
            });

        } catch (error) {
            registryResult.className = 'test-result error';
            registryResult.innerHTML = `
                <strong>✗ Import failed!</strong><br>
                ${error.message}<br><br>
                <strong>Note:</strong> ES module imports may not work with file:// in some browsers.
                Try opening this page in Chrome or Edge.
            `;

            dynamicResult.className = 'test-result error';
            dynamicResult.textContent = 'Skipped due to registry import failure';
        }
    </script>

    <hr style="margin-top: 3rem;">

    <h2>Troubleshooting</h2>
    <ul>
        <li><strong>Chrome/Edge:</strong> ES module imports should work with file:// protocol</li>
        <li><strong>Firefox:</strong> May require disabling <code>security.fileuri.strict_origin_policy</code> in about:config</li>
        <li><strong>Safari:</strong> May require serving from a local server instead</li>
    </ul>
    <p>If imports fail, you can still use a local server:</p>
    <pre>python3 -m http.server 8000</pre>
    <p>Then open <a href="http://localhost:8000/test-es-modules.html">http://localhost:8000/test-es-modules.html</a></p>
</body>
</html>
