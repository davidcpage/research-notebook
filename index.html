<!-- ========== SECTION: HTML_HEAD ========== -->
<!-- External dependencies: PDF.js, Marked.js, KaTeX, Pyodide, Highlight.js, CodeMirror -->
<!-- CSS styles linked from css/app.css -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Content Security Policy: Restricts where data can be sent -->
    <!-- connect-src whitelist: 'self', api.microlink.io (thumbnails), jsdelivr (GitHub repos + Pyodide) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' cdnjs.cloudflare.com cdn.jsdelivr.net esm.sh; style-src 'self' 'unsafe-inline' cdnjs.cloudflare.com fonts.googleapis.com; font-src 'self' fonts.gstatic.com; img-src 'self' data: blob: https://api.microlink.io; connect-src 'self' https://api.microlink.io https://cdn.jsdelivr.net https://data.jsdelivr.com https://api.github.com; worker-src 'self' blob:; object-src 'none';">
    <title>Research Notebook</title>
    <!-- CodeMirror 6 import map for editor syntax highlighting -->
    <script type="importmap">
    {
        "imports": {
            "style-mod": "https://esm.sh/style-mod@4.1.2",
            "w3c-keyname": "https://esm.sh/w3c-keyname@2.2.8",
            "crelt": "https://esm.sh/crelt@1.0.6",
            "@marijn/find-cluster-break": "https://esm.sh/@marijn/find-cluster-break@1.0.2",
            "@lezer/common": "https://esm.sh/*@lezer/common@1.2.3",
            "@lezer/highlight": "https://esm.sh/*@lezer/highlight@1.2.1",
            "@lezer/lr": "https://esm.sh/*@lezer/lr@1.4.2",
            "@lezer/python": "https://esm.sh/*@lezer/python@1.1.15",
            "@lezer/yaml": "https://esm.sh/*@lezer/yaml@1.0.3",
            "@lezer/css": "https://esm.sh/*@lezer/css@1.1.9",
            "@lezer/markdown": "https://esm.sh/*@lezer/markdown@1.6.1",
            "@lezer/html": "https://esm.sh/*@lezer/html@1.3.12",
            "@lezer/javascript": "https://esm.sh/*@lezer/javascript@1.5.4",
            "@codemirror/autocomplete": "https://esm.sh/*@codemirror/autocomplete@6.18.4",
            "@codemirror/commands": "https://esm.sh/*@codemirror/commands@6.7.1",
            "@codemirror/language": "https://esm.sh/*@codemirror/language@6.10.6",
            "@codemirror/lint": "https://esm.sh/*@codemirror/lint@6.8.4",
            "@codemirror/search": "https://esm.sh/*@codemirror/search@6.5.8",
            "@codemirror/state": "https://esm.sh/*@codemirror/state@6.5.0",
            "@codemirror/view": "https://esm.sh/*@codemirror/view@6.35.0",
            "@codemirror/lang-python": "https://esm.sh/*@codemirror/lang-python@6.1.6",
            "@codemirror/lang-yaml": "https://esm.sh/*@codemirror/lang-yaml@6.1.2",
            "@codemirror/lang-css": "https://esm.sh/*@codemirror/lang-css@6.3.1",
            "@codemirror/lang-markdown": "https://esm.sh/*@codemirror/lang-markdown@6.5.0",
            "@codemirror/lang-html": "https://esm.sh/*@codemirror/lang-html@6.4.11",
            "@codemirror/lang-javascript": "https://esm.sh/*@codemirror/lang-javascript@6.2.4",
            "@codemirror/theme-one-dark": "https://esm.sh/*@codemirror/theme-one-dark@6.1.2",
            "codemirror": "https://esm.sh/*codemirror@6.0.1"
        }
    }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Playfair+Display:wght@400;600&family=Source+Sans+3:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Marked.js for markdown rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
    <!-- Pyodide for Python execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js"></script>
    <!-- js-yaml for YAML parsing (template system) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <!-- jsdiff for template diff display -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
    <!-- notebook.js for Jupyter notebook rendering -->
    <script src="https://cdn.jsdelivr.net/npm/notebookjs@0.6.7/notebook.min.js"></script>
    <!-- Highlight.js for syntax highlighting (CSS inlined in @layer vendors below) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/dockerfile.min.js"></script>
    <link rel="stylesheet" href="css/app.css">
</head>
<!-- ========== SECTION: HTML_BODY_AND_MODALS ========== -->
<!-- Header, toolbar, main content area, and all modal templates -->
<body class="loading">
    <header>
        <div class="header-content">
            <h1 id="headerTitle">Research Notebook</h1>
            <p class="tagline" id="headerSubtitle">Bookmarks, notes, and connections</p>
        </div>
    </header>

    <div class="toolbar">
        <div class="toolbar-group">
            <button class="btn btn-primary" onclick="openSectionModal()">
                <span class="btn-icon">+</span> New Section
            </button>
        </div>
        <div class="toolbar-group" style="margin-left: auto;">
            <button id="diffModeBtn" class="btn btn-secondary btn-icon-only" onclick="toggleDiffMode()" title="Compare with previous commit" style="display: none;">
                <span class="btn-icon">â—”</span>
            </button>
            <button class="btn btn-secondary btn-icon-only" onclick="openSettingsEditor()" title="Settings">
                <span class="btn-icon">âš™</span>
            </button>
        </div>
    </div>

    <main id="content">
        <div class="empty-state">
            <div class="empty-state-icon">ðŸ“š</div>
            <h2>Your research notebook awaits</h2>
            <p>Create a section to start organizing your bookmarks and notes</p>
        </div>
    </main>

    <!-- Section Modal -->
    <div class="modal-overlay" id="sectionModal">
        <div class="modal">
            <div class="modal-header">
                <h2>New Section</h2>
                <button class="modal-close" onclick="closeSectionModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="sectionName">Section Name</label>
                    <input type="text" id="sectionName" placeholder="e.g., Machine Learning Papers">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSectionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createSection()">Create Section</button>
            </div>
        </div>
    </div>

    <!-- Generic Viewer Modal (Phase 2 Template System) -->
    <div class="modal-overlay" id="viewerModal">
        <div class="modal viewer" data-template="">
            <div class="modal-header">
                <h2 id="viewerTitle">Title</h2>
                <span id="viewerTags" class="viewer-tags"></span>
                <button class="modal-close" onclick="closeViewer()">Ã—</button>
            </div>
            <div class="viewer-content" id="viewerContent"></div>
            <div id="viewerBacklinks" class="viewer-backlinks"></div>
            <div class="viewer-footer">
                <span id="viewerMeta" class="viewer-meta"></span>
                <div id="viewerActions" class="viewer-actions"></div>
            </div>
        </div>
    </div>

    <!-- Generic Editor Modal (Phase 3 Template System) -->
    <div class="modal-overlay" id="editorModal">
        <div class="modal modal-large" data-template="">
            <div class="modal-header">
                <h2 id="editorTitle">New Card</h2>
                <button class="modal-close" onclick="closeEditor()">Ã—</button>
            </div>
            <div class="modal-body" id="editorBody">
                <!-- Section selector (injected first) -->
                <!-- Dynamic fields from template.editor.fields -->
            </div>
            <div id="editorOutput" class="form-group" style="display: none;">
                <label>Output</label>
                <div class="code-output" id="editorCodeOutput"></div>
            </div>
            <div class="modal-footer">
                <div id="editorActions" class="editor-actions-left"></div>
                <div class="editor-actions-right">
                    <button class="btn btn-secondary" onclick="closeEditor()">Cancel</button>
                    <button class="btn btn-primary" id="editorSubmitBtn" onclick="saveEditor()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Diff Modal -->
    <div class="modal-overlay" id="diffModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h2 id="diffTitle">Template Changes</h2>
                <button class="modal-close" onclick="closeDiffModal()">Ã—</button>
            </div>
            <div class="modal-body diff-body">
                <div class="diff-legend">
                    <span class="diff-legend-item"><span class="diff-removed-sample">âˆ’</span> Removed from defaults</span>
                    <span class="diff-legend-item"><span class="diff-added-sample">+</span> Added/changed</span>
                </div>
                <pre class="diff-content" id="diffContent"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDiffModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div class="modal-overlay" id="onboardingModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Welcome to Research Notebook</h2>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px 20px;">
                <div style="font-size: 4rem; margin-bottom: 20px;">ðŸ“š</div>
                <p style="color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 20px; line-height: 1.6;">
                    Your notebook is stored as files, making it easy to use with Claude Code and track changes with git.
                </p>
                <div id="onboardingFilesystemOption">
                    <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 20px;">
                        Choose a folder to store your notebook, or connect to a GitHub repository.
                    </p>
                    <button class="btn btn-primary" onclick="setupNotebookFolder()" style="padding: 12px 32px; font-size: 1.1rem;">
                        Choose Notebook Folder
                    </button>
                    <div style="margin: 16px 0; color: var(--text-muted); font-size: 0.9rem;">or</div>
                    <button class="btn btn-secondary" onclick="closeOnboarding(); showGitHubConnectModal()" style="padding: 10px 28px; font-size: 1rem;">
                        Connect to GitHub
                    </button>
                </div>
                <div id="onboardingGitHubOnly" style="display: none;">
                    <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 20px;">
                        Connect to a GitHub repository to read and edit your notebook from any browser.
                    </p>
                    <button class="btn btn-primary" onclick="closeOnboarding(); showGitHubConnectModal()" style="padding: 12px 32px; font-size: 1.1rem;">
                        Connect to GitHub
                    </button>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 16px;">
                        Local folder access requires Chrome or Edge on desktop.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- GitHub Connect Modal -->
    <div class="modal-overlay" id="githubConnectModal">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header">
                <h2>Connect to GitHub</h2>
                <button class="modal-close" onclick="closeGitHubConnectModal()">Ã—</button>
            </div>
            <div class="modal-body github-connect-body">
                <div class="form-group">
                    <label for="githubToken">Personal Access Token</label>
                    <input type="password" id="githubToken" placeholder="ghp_... or github_pat_...">
                    <p class="field-help">Create a <a href="https://github.com/settings/personal-access-tokens/new" target="_blank" rel="noopener">fine-grained token</a> with Contents read/write access.</p>
                </div>
                <div class="form-group">
                    <label for="githubRepo">Repository</label>
                    <input type="text" id="githubRepo" placeholder="owner/repo">
                </div>
                <div class="form-group">
                    <label for="githubBranch">Branch</label>
                    <input type="text" id="githubBranch" placeholder="main" value="main">
                </div>
                <div id="githubConnectError" class="github-connect-message github-connect-error" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGitHubConnectModal()">Cancel</button>
                <button class="btn btn-primary" id="githubConnectBtn" onclick="handleGitHubConnect()">Connect</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>


    <script src="js/app.js"></script>
</body>
</html>
