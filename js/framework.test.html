<!DOCTYPE html>
<html>
<head>
    <title>Framework Module Test</title>
    <!-- Load external libraries first (same as index.html) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        body { font-family: system-ui; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Framework Module Test</h1>
    <div id="results"></div>

    <script type="module">
        import {
            escapeHtml,
            escapeJsAttr,
            truncateText,
            formatDate,
            getPlainTextPreview,
            marked,
            hljs,
            jsyaml,
            getData,
            findCardById,
            registerNotebook
        } from '/js/framework.js';

        const results = document.getElementById('results');

        function test(name, fn) {
            const div = document.createElement('div');
            div.className = 'test';
            try {
                const result = fn();
                if (result === true) {
                    div.className += ' pass';
                    div.textContent = `✓ ${name}`;
                } else {
                    div.className += ' fail';
                    div.textContent = `✗ ${name}: ${result}`;
                }
            } catch (e) {
                div.className += ' fail';
                div.textContent = `✗ ${name}: ${e.message}`;
            }
            results.appendChild(div);
        }

        // Test pure utilities
        test('escapeHtml works', () => {
            const result = escapeHtml('<script>alert("xss")</script>');
            return result.includes('&lt;') && result.includes('&gt;');
        });

        test('escapeJsAttr works', () => {
            const result = escapeJsAttr("it's a \"test\"");
            return result.includes("\\'") && result.includes('&quot;');
        });

        test('truncateText works', () => {
            return truncateText('Hello World', 8) === 'Hello...';
        });

        test('formatDate works', () => {
            const result = formatDate('2025-01-15T10:00:00Z');
            return typeof result === 'string' && result.includes('Jan');
        });

        test('getPlainTextPreview works', () => {
            const result = getPlainTextPreview('# Hello **World**');
            return result === 'Hello World';
        });

        // Test library re-exports
        test('marked is available', () => {
            return typeof marked?.parse === 'function';
        });

        test('hljs is available', () => {
            return typeof hljs?.highlight === 'function';
        });

        test('jsyaml is available', () => {
            return typeof jsyaml?.load === 'function';
        });

        // Test data model helpers (should return null when no data)
        test('getData returns undefined when no notebook', () => {
            return getData() === undefined;
        });

        test('findCardById returns null when no notebook', () => {
            return findCardById('123') === null;
        });

        // Test registerNotebook
        test('registerNotebook creates window.notebook', () => {
            registerNotebook({ testProp: 'works' });
            return window.notebook?.testProp === 'works';
        });

        // Summary
        const passed = document.querySelectorAll('.pass').length;
        const failed = document.querySelectorAll('.fail').length;
        const summary = document.createElement('h2');
        summary.textContent = `Results: ${passed} passed, ${failed} failed`;
        summary.style.color = failed > 0 ? '#dc3545' : '#28a745';
        results.insertBefore(summary, results.firstChild);
    </script>
</body>
</html>
